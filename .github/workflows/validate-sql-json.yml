name: Validate SQL and JSON

on:
  push:
    branches: [ master, main ]
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install SQL parser
        run: |
          python -m pip install --upgrade pip
          pip install sqlfluff

      - name: Validate JSON syntax
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          ignored_parts = {'.venv', '.venv2', '__pycache__'}
          json_files = [
              p for p in Path('.').rglob('*.json')
              if not any(part in ignored_parts for part in p.parts)
          ]

          errors = []
          for path in sorted(json_files):
              try:
                  with path.open('r', encoding='utf-8') as file:
                      json.load(file)
              except Exception as exc:
                  errors.append(f"{path}: {exc}")

          if errors:
              print('JSON validation failed:')
              for error in errors:
                  print(f'- {error}')
              raise SystemExit(1)

          print(f'JSON validation passed ({len(json_files)} files).')
          PY

      - name: Validate SQL syntax (T-SQL)
        run: |
          mapfile -t SQL_FILES < <(find sql -type f -name '*.sql' | sort)
          if [ ${#SQL_FILES[@]} -eq 0 ]; then
            echo "No SQL files found under sql/."
            exit 0
          fi

          for file in "${SQL_FILES[@]}"; do
            echo "Parsing $file"
            sqlfluff parse "$file" --dialect tsql >/dev/null
          done

          echo "SQL validation passed (${#SQL_FILES[@]} files)."
